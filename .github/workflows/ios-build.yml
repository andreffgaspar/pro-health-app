name: Build iOS App

on:
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
      - name: Checkout código
        uses: actions/checkout@v3

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Instalar dependências
        run: npm install --legacy-peer-deps

      - name: Build Vite
        run: npm run build

      - name: Instalar Capacitor
        run: npm install -g @capacitor/cli

      - name: Adicionar iOS
        run: npx cap add ios

      - name: Sincronizar Capacitor
        run: npx cap sync

      - name: Preparar certificado
        run: |
          echo "$IOS_CERTIFICATE" | base64 --decode > certificate.p12
          echo "$IOS_PROFILE" | base64 --decode > profile.mobileprovision
          security create-keychain -p github ios-build.keychain
          security default-keychain -s ios-build.keychain
          security unlock-keychain -p github ios-build.keychain
          security import certificate.p12 -k ios-build.keychain -P "$IOS_CERT_PASSWORD" -T /usr/bin/codesign
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/

      - name: Verificar Schemes disponíveis
        run: |
          cd ios/App
          xcodebuild -list

      - name: Build com Xcode
        run: |
          cd ios/App
          xcodebuild -scheme App -configuration Release -workspace App.xcworkspace -sdk iphoneos -archivePath $PWD/build/App.xcarchive archive

      - name: Exportar IPA
        run: |
          xcodebuild -exportArchive -archivePath ios/App/build/App.xcarchive -exportOptionsPlist ios/App/exportOptions.plist -exportPath ios/App/build

      - name: Upload do .ipa
        uses: actions/upload-artifact@v3
        with:
          name: app-ios
          path: ios/App/build/*.ipa

      - name: Enviar para TestFlight
        run: |
          xcrun altool --upload-app --type ios --file ios/App/build/App.ipa \
          --username "$APPLE_ID" --password "$APP_SPECIFIC_PASSWORD"

